<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no" />
  <title>Registro | SiraIA</title>
  <meta name="theme-color" content="#6F8576" />
  <style>
    :root{
      --bg-app:#EDEAE0;      /* crema */
      --panel:#F6F4EF;       /* tarjeta */
      --ink:#3A3D3B;         /* texto principal */
      --muted:#596264;       /* texto secundario */
      --brand:#6F8576;       /* verde marca */
      --brand-strong:#556D60;
      --ring:#E0E6E0;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg-app);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;
      padding:16px clamp(10px,2vw,20px) calc(16px + env(safe-area-inset-bottom));
      display:flex;align-items:flex-start;justify-content:center;
    }
    .wrap{
      width:100%; max-width:720px;
      background:var(--panel);
      border-radius:20px;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .banner{background:var(--brand);color:#fff;padding:16px 20px}
    .banner h1{margin:0 0 6px 0;font-size:clamp(20px,3.8vw,28px);letter-spacing:.2px}
    .banner p{margin:0;opacity:.95}
    .content{padding:18px;display:grid;gap:14px}

    .help-card{border:1px dashed #D9E0DA;background:#FFF;padding:12px 14px;border-radius:14px;color:var(--ink)}
    .help-card b{display:block;margin-bottom:4px}

    .card{background:#fff;border:1px solid var(--ring);border-radius:14px;padding:14px;position:relative}

    label.small{display:block;font-weight:700;font-size:14px;margin:10px 0 6px}
    input[type="text"],input[type="email"],input[type="date"],select, input[type="tel"]{
      width:100%;border:1px solid var(--ring);border-radius:12px;
      padding:12px 14px;font-size:16px;background:#fff;color:var(--ink);outline:none
    }
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#8A948E 50%),linear-gradient(135deg,#8A948E 50%,transparent 50%),linear-gradient(to right,transparent,transparent);
      background-position:calc(100% - 18px) calc(50% - 3px),calc(100% - 12px) calc(50% - 3px),calc(100% - 2.4em) 0.5em;background-size:6px 6px,6px 6px,1px 1.8em;background-repeat:no-repeat;cursor:pointer}
    input::placeholder{color:#8C9590}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}

    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:720px){ .row.two{grid-template-columns:1fr 1fr} }

    .phone-row{display:grid;grid-template-columns:100px 1fr;gap:10px}
    .prefix{display:flex;align-items:center;justify-content:center;border:1px solid var(--ring);background:#fff;border-radius:12px;font-weight:800;font-size:18px}

    .consent{display:flex;align-items:flex-start;gap:12px;border:1px solid var(--ring);background:#fff;padding:10px 12px;border-radius:12px;line-height:1.35;word-break:break-word}
    .consent .text{font-size:14px;color:var(--ink)}
    .consent a{color:var(--brand-strong);font-weight:700;text-decoration:underline}
    .consent input{margin-top:3px;width:20px;height:20px}

    .cta{margin-top:6px;background:var(--brand);color:#fff;border:none;width:100%;
      padding:14px 16px;border-radius:12px;font-weight:800;font-size:16px;box-shadow:0 6px 18px rgba(0,0,0,.12);cursor:pointer}
    .cta:disabled{opacity:.5;cursor:not-allowed}

    .pill{display:inline-block;background:#EEF2EE;border:1px solid #E0E8E1;color:#3F4A44;font-weight:800;padding:6px 10px;border-radius:999px}

    [hidden]{display:none!important}
    .success{background:#F1F5F2;border:1px solid var(--ring);border-radius:14px;padding:14px}
    .center{text-align:center}
    .go{background:#6F8576;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="banner">
      <h1 id="i_bannerTitle">¡Hola! Soy SiraIA</h1>
      <p id="i_bannerSubtitle">Te ayudo a registrarte en menos de 1 minuto.</p>
    </div>

    <div class="content">
      <div id="help-card" class="help-card">
        <b id="i_helpTitle">La activación de SiraIA se asocia a tu número de celular</b>
        <div id="i_help1">Al llenar la sección de tu número celular, elige el país al que pertenece tu número y pondré el prefijo automáticamente. Luego escribe solo los dígitos de tu celular.</div>
        <div id="i_help2">Al final, pulsa <em>“Enviar código por SMS”</em>; recibirás un código de 6 dígitos para validarlo aquí mismo.</div>
      </div>

      <!-- PASO: FORMULARIO -->
      <section id="step-form" class="card">
        <form id="reg-form" novalidate>
          <label class="small" id="i_fullNameLabel">Nombre completo</label>
          <input id="fullName" type="text" inputmode="text" placeholder="Nombre(s) y al menos un apellido" required />
          <div class="hint" id="i_statsHint">Solo para estadísticas internas.</div>

          <label class="small" id="i_friendlyLabel">¿Con qué nombre me dirijo a ti?</label>
          <input id="friendlyName" type="text" placeholder="Ej. Lupita / Juan / Ale" required />
          <div class="hint" id="i_friendlyHint">Usaré este nombre en nuestras conversaciones para referirme a ti.</div>

          <div class="row two">
            <div>
              <label class="small" id="i_emailLabel">Correo (opcional)</label>
              <input id="email" type="email" placeholder="tucorreo@ejemplo.com" />
            </div>
            <div>
              <label class="small" id="i_countryFreeLabel">¿De qué país eres?</label>
              <input id="countryFree" type="text" placeholder="Escribe tu país (texto libre)" />
              <div class="hint" id="i_countryFreeHint">Solo para estadísticas internas.</div>
            </div>
          </div>

          <label class="small" id="i_phoneOfCountryLabel">¿El número de tu celular de qué país es?</label>
          <select id="phoneCountrySel" aria-label="País del teléfono">
            <!-- América Latina + NA / EU / APAC comunes -->
            <option value="MX" data-dial="+52" selected>México (+52)</option>
            <option value="US" data-dial="+1">Estados Unidos / United States (+1)</option>
            <option value="CA" data-dial="+1">Canadá / Canada (+1)</option>
            <option value="CO" data-dial="+57">Colombia (+57)</option>
            <option value="PE" data-dial="+51">Perú (+51)</option>
            <option value="AR" data-dial="+54">Argentina (+54)</option>
            <option value="CL" data-dial="+56">Chile (+56)</option>
            <option value="BR" data-dial="+55">Brasil / Brazil (+55)</option>
            <option value="ES" data-dial="+34">España / Spain (+34)</option>
            <option value="UK" data-dial="+44">Reino Unido / United Kingdom (+44)</option>
            <option value="DE" data-dial="+49">Alemania / Germany (+49)</option>
            <option value="FR" data-dial="+33">Francia / France (+33)</option>
            <option value="IT" data-dial="+39">Italia / Italy (+39)</option>
            <option value="PT" data-dial="+351">Portugal (+351)</option>
            <option value="NL" data-dial="+31">Países Bajos / Netherlands (+31)</option>
            <option value="BE" data-dial="+32">Bélgica / Belgium (+32)</option>
            <option value="SE" data-dial="+46">Suecia / Sweden (+46)</option>
            <option value="NO" data-dial="+47">Noruega / Norway (+47)</option>
            <option value="DK" data-dial="+45">Dinamarca / Denmark (+45)</option>
            <option value="FI" data-dial="+358">Finlandia / Finland (+358)</option>
            <option value="IE" data-dial="+353">Irlanda / Ireland (+353)</option>
            <option value="CH" data-dial="+41">Suiza / Switzerland (+41)</option>
            <option value="AU" data-dial="+61">Australia (+61)</option>
            <option value="NZ" data-dial="+64">Nueva Zelanda / New Zealand (+64)</option>
            <option value="JP" data-dial="+81">Japón / Japan (+81)</option>
            <option value="KR" data-dial="+82">Corea del Sur / South Korea (+82)</option>
            <option value="CN" data-dial="+86">China (+86)</option>
            <option value="IN" data-dial="+91">India (+91)</option>
            <option value="ZA" data-dial="+27">Sudáfrica / South Africa (+27)</option>
            <option value="MA" data-dial="+212">Marruecos / Morocco (+212)</option>
            <option value="EG" data-dial="+20">Egipto / Egypt (+20)</option>
            <option value="TR" data-dial="+90">Turquía / Türkiye (+90)</option>
            <option value="IL" data-dial="+972">Israel (+972)</option>
            <option value="SA" data-dial="+966">Arabia Saudita / Saudi Arabia (+966)</option>
            <option value="AE" data-dial="+971">Emiratos Árabes Unidos / UAE (+971)</option>
            <!-- C. América + Caribe -->
            <option value="GT" data-dial="+502">Guatemala (+502)</option>
            <option value="SV" data-dial="+503">El Salvador (+503)</option>
            <option value="HN" data-dial="+504">Honduras (+504)</option>
            <option value="NI" data-dial="+505">Nicaragua (+505)</option>
            <option value="CR" data-dial="+506">Costa Rica (+506)</option>
            <option value="PA" data-dial="+507">Panamá (+507)</option>
            <option value="DO" data-dial="+1">República Dominicana (+1)</option>
            <option value="PR" data-dial="+1">Puerto Rico (+1)</option>
            <option value="EC" data-dial="+593">Ecuador (+593)</option>
            <option value="VE" data-dial="+58">Venezuela (+58)</option>
            <option value="UY" data-dial="+598">Uruguay (+598)</option>
            <option value="PY" data-dial="+595">Paraguay (+595)</option>
            <option value="BO" data-dial="+591">Bolivia (+591)</option>
            <!-- Fallback -->
            <option value="OTHER" data-dial="">Otro país / Other…</option>
          </select>

          <!-- Prefijo manual si elige “Otro país” -->
          <div id="otherPrefixRow" class="row" hidden style="margin-top:8px">
            <div>
              <label class="small" id="i_otherPrefixLabel">Prefijo internacional (ej. +372)</label>
              <input id="otherPrefix" type="tel" inputmode="numeric" placeholder="+XXX" />
              <div class="hint" id="i_otherPrefixHint">Escribe el prefijo con + y dígitos (1–4 cifras).</div>
            </div>
          </div>

          <div class="phone-row" style="margin-top:10px">
            <div class="prefix" id="prefixBox">+52</div>
            <input id="phoneDigits" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="20"
                   placeholder="Solo dígitos, sin espacios" autocomplete="tel"/>
          </div>
          <div id="smsPreview" class="hint">Se enviará SMS a: +52 ••••••••</div>

          <label class="small" id="i_birthdateLabel">Fecha de nacimiento
            <span id="i_birthdateHintInline" style="font-weight:600;color:#6b7280">(toca el año para cambiarlo)</span>
          </label>
          <input id="birthdate" type="date" />

          <div class="consent">
            <input id="accept" type="checkbox" />
            <div class="text" id="i_consentHTML">
              Acepto las
              <a href="/privacidad" target="_blank" rel="noopener">Políticas de privacidad</a>
              y
              <a href="/terminos" target="_blank" rel="noopener">Términos de uso</a>.
            </div>
          </div>

          <button id="sendCode" class="cta" type="button" disabled>Enviar código por SMS</button>
          <div id="recaptcha-container"></div>
        </form>
      </section>

      <!-- PASO: OTP -->
      <section id="step-otp" class="card" hidden>
        <label class="small" id="i_otpLabel">Ingresa el código de 6 dígitos</label>
        <input id="otp" type="tel" inputmode="numeric" maxlength="6" placeholder="123456" autocomplete="one-time-code"/>
        <div class="row two" style="margin-top:10px">
          <button id="verify" class="cta" type="button">Validar código</button>
          <button id="resend" class="go" type="button">Reenviar SMS</button>
        </div>
        <div id="otpHint" class="hint" aria-live="polite"></div>
      </section>

      <!-- PASO: ÉXITO -->
      <section id="step-success" class="success" hidden>
        <p id="i_successTitle"><b>¡Listo!</b> Tu cuenta fue creada.</p>
        <p id="i_successSub">Te regalé <b>10 créditos</b> para comenzar: puedes preguntar por <i>texto</i>, <i>audio</i> o <i>imagen + texto</i>.</p>
        <p class="center" id="pill" style="margin:8px 0 0">
          <span class="pill" id="pillText">Créditos: 10/10</span>
        </p>
        <div class="center" style="margin-top:10px">
          <a class="go" id="i_goChat" href="/">Ir al chat</a>
        </div>
        <p class="center" id="i_successFoot" style="margin:12px 0 0;color:var(--muted);font-size:12px">
          SiraIA es clara, empática y cuida tu privacidad.
        </p>
      </section>
    </div>
  </div>

  <!-- Firebase + lógica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBT4hTvAWk5lAT_OuJHjPCyKVUQ7jDpEAc",
      authDomain: "siraia.firebaseapp.com",
      projectId: "siraia",
      storageBucket: "siraia.firebasestorage.app",
      messagingSenderId: "264146805016",
      appId: "1:264146805016:web:9ad62adc579ec4c6c43e6d"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    auth.languageCode = 'es';

    /* ===== i18n (ES → EN si el navegador no es español) ===== */
    const I18N = {
      en: {
        bannerTitle:"Hi! I'm SiraIA",
        bannerSubtitle:"I'll help you register in under a minute.",
        helpTitle:"Activate with your phone",
        help1:"Choose your phone’s country and I’ll set the prefix automatically. Then type only your digits.",
        help2:'At the end, press <em>“Send code by SMS”</em>; you’ll receive a 6-digit code to validate here.',
        fullNameLabel:"Full name",
        fullNamePh:"First name(s) and at least one surname",
        statsHint:"For internal statistics only.",
        friendlyLabel:"How should I call you?",
        friendlyPh:"e.g. Lupita / Juan / Ale",
        friendlyHint:"I’ll use this name in our conversations to address you.",
        emailLabel:"Email (optional)",
        countryFreeLabel:"Which country are you from?",
        countryFreePh:"Write your country (free text)",
        countryFreeHint:"For internal statistics only.",
        phoneOfCountryLabel:"Your phone number is from which country?",
        digitsPh:"Digits only, no spaces",
        smsLead:"SMS will be sent to:",
        birthdateLabel:"Birthdate",
        birthdateHintInline:"(Tap the year to change it)",
        consentHTML:'I accept the <a href="/privacy" target="_blank" rel="noopener">Privacy Policy</a> and <a href="/terms" target="_blank" rel="noopener">Terms of Use</a>.',
        sendCode:"Send code by SMS",
        otpLabel:"Enter the 6-digit code",
        validateCode:"Validate code",
        resend:"Resend SMS",
        successTitle:"<b>All set!</b> Your account was created.",
        successSub:"I gave you <b>10 credits</b> to start: you can ask via <i>text</i>, <i>audio</i> or <i>image + text</i>.",
        creditsPill:"Credits:",
        goChat:"Go to chat",
        successFoot:"SiraIA is clear, empathetic, and cares about your privacy.",
        otherPrefixLabel:"International prefix (e.g. +372)",
        otherPrefixHint:"Write the prefix with + and digits (1–4 numbers).",
        couldntSms:"I couldn’t send the SMS. Please check the number and try again."
      }
    };
    function isEs(){ return (navigator.language||'es').toLowerCase().startsWith('es'); }
    function t(key, fallback){ if(isEs()) return fallback; return I18N.en[key] || fallback; }
    function applyI18n(){
      if(isEs()) return;
      document.documentElement.lang='en';
      i_bannerTitle.textContent = I18N.en.bannerTitle;
      i_bannerSubtitle.textContent = I18N.en.bannerSubtitle;
      i_helpTitle.textContent = I18N.en.helpTitle;
      i_help1.textContent = I18N.en.help1;
      i_help2.innerHTML  = I18N.en.help2;
      i_fullNameLabel.textContent = I18N.en.fullNameLabel;
      fullName.placeholder = I18N.en.fullNamePh;
      i_statsHint.textContent = I18N.en.statsHint;
      i_friendlyLabel.textContent = I18N.en.friendlyLabel;
      friendlyName.placeholder = I18N.en.friendlyPh;
      i_friendlyHint.textContent = I18N.en.friendlyHint;
      i_emailLabel.textContent  = I18N.en.emailLabel;
      i_countryFreeLabel.textContent = I18N.en.countryFreeLabel;
      countryFree.placeholder = I18N.en.countryFreePh;
      i_countryFreeHint.textContent = I18N.en.countryFreeHint;
      i_phoneOfCountryLabel.textContent = I18N.en.phoneOfCountryLabel;
      phoneDigits.placeholder = I18N.en.digitsPh;
      i_birthdateLabel.firstChild && (i_birthdateLabel.firstChild.textContent = I18N.en.birthdateLabel + ' ');
      i_birthdateHintInline.textContent = I18N.en.birthdateHintInline;
      i_consentHTML.innerHTML = I18N.en.consentHTML;
      sendCode.textContent = I18N.en.sendCode;
      i_otpLabel.textContent = I18N.en.otpLabel;
      verify.textContent = I18N.en.validateCode;
      resend.textContent = I18N.en.resend;
      i_successTitle.innerHTML = I18N.en.successTitle;
      i_successSub.innerHTML   = I18N.en.successSub;
      i_goChat.textContent     = I18N.en.goChat;
      i_successFoot.textContent= I18N.en.successFoot;
      i_otherPrefixLabel.textContent = I18N.en.otherPrefixLabel;
      i_otherPrefixHint.textContent  = I18N.en.otherPrefixHint;
      auth.languageCode = 'en';
    }
    applyI18n();

    /* ===== Refs ===== */
    const stepForm = document.getElementById('step-form');
    const stepOtp  = document.getElementById('step-otp');
    const stepSuccess = document.getElementById('step-success');
    const helpCard = document.getElementById('help-card');

    const fullName = document.getElementById('fullName');
    const friendlyName = document.getElementById('friendlyName');
    const email = document.getElementById('email');
    const countryFree = document.getElementById('countryFree');

    const phoneCountrySel = document.getElementById('phoneCountrySel');
    const otherPrefixRow  = document.getElementById('otherPrefixRow');
    const otherPrefix     = document.getElementById('otherPrefix');

    const prefixBox = document.getElementById('prefixBox');
    const phoneDigits = document.getElementById('phoneDigits');
    const smsPreview = document.getElementById('smsPreview');

    const accept = document.getElementById('accept');
    const sendCode = document.getElementById('sendCode');

    const otp = document.getElementById('otp');
    const verifyBtn = document.getElementById('verify');
    const resendBtn = document.getElementById('resend');
    const otpHint = document.getElementById('otpHint');

    const birthdate = document.getElementById('birthdate');
    const pillText = document.getElementById('pillText');

    /* ===== Lógica del prefijo ===== */
    function getSelectedDial(){
      const opt = phoneCountrySel.options[phoneCountrySel.selectedIndex];
      const dial = opt?.dataset?.dial || '';
      if (dial) return dial;
      // “Other” → leer manual
      const raw = (otherPrefix.value || '').trim();
      if (/^\+\d{1,4}$/.test(raw)) return raw;
      return '+52'; // fallback
    }
    function maskPhone(ph){ 
      if (!ph) return '••••••••';
      const d = ph.replace(/\D+/g,''); 
      if (d.length<=4) return '••' + d;
      return d.slice(0,2) + '••••' + d.slice(-2);
    }
    function updatePrefixUI(){
      const isOther = phoneCountrySel.value === 'OTHER';
      otherPrefixRow.hidden = !isOther;
      const dial = getSelectedDial();
      prefixBox.textContent = dial;
      const lead = isEs()? 'Se enviará SMS a:' : 'SMS will be sent to:';
      smsPreview.textContent = `${lead} ${dial} ${maskPhone(phoneDigits.value||'')}`;
      validateForm();
    }
    phoneCountrySel.addEventListener('change', updatePrefixUI);
    otherPrefix.addEventListener('input', ()=>{
      // Sanitiza a formato +NNN
      let v = otherPrefix.value.toUpperCase().replace(/[^\d+]/g,'');
      if (!v.startsWith('+')) v = '+' + v.replace(/\+/g,'');
      v = v.replace(/(\+\d{0,4}).*/,'$1'); // limita a + y 4 dígitos
      otherPrefix.value = v;
      updatePrefixUI();
    });
    phoneDigits.addEventListener('input', updatePrefixUI);

    // Auto idioma inicial MX/US por idioma del navegador
    if (!isEs()){
      // si navegador no es ES, sugerimos US
      phoneCountrySel.value = 'US';
    } else {
      phoneCountrySel.value = 'MX';
    }
    updatePrefixUI();

    /* ===== Helpers generales ===== */
    function showStep(which){
      stepForm.hidden = which!=='form';
      stepOtp.hidden = which!=='otp';
      stepSuccess.hidden = which!=='success';
      helpCard.style.display = (which==='success')? 'none' : '';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function currentE164(){
      const dial = getSelectedDial();
      const digits = (phoneDigits.value||'').replace(/\D+/g,'');
      return dial + digits;
    }
    function validateForm(){
      const hasDigits = phoneDigits.value.replace(/\D+/g,'').length >= 6;
      const dialOk = /^\+\d{1,4}$/.test(getSelectedDial());
      const ok =
        fullName.value.trim().length >= 3 &&
        friendlyName.value.trim().length >= 2 &&
        hasDigits &&
        dialOk &&
        accept.checked;
      sendCode.disabled = !ok;
    }
    [fullName,friendlyName,email,countryFree,phoneDigits,accept].forEach(el=>{
      el.addEventListener('input', validateForm);
      el.addEventListener('change', validateForm);
    });
    validateForm();

    /* ===== reCAPTCHA ===== */
    let appVerifier=null;
    function ensureRecaptcha(){
      if (appVerifier) return appVerifier;
      appVerifier = new RecaptchaVerifier(auth,'recaptcha-container',{size:'invisible'});
      return appVerifier;
    }

    /* ===== Enviar SMS ===== */
    sendCode.addEventListener('click', async ()=>{
      try{
        sendCode.disabled = true;
        const e164 = currentE164();
        await signOut(auth).catch(()=>{});
        // Inicializa recaptcha (iOS/Safari agradece que exista antes de llamar)
        ensureRecaptcha();
        const confirmation = await signInWithPhoneNumber(auth, e164, appVerifier);
        window._sira_confirm = confirmation;
        otpHint.textContent = isEs()
          ? 'Te envié un SMS. Ingresa el código de 6 dígitos.'
          : 'I sent you an SMS. Enter the 6-digit code.';
        showStep('otp');
      }catch(err){
        console.error(err);
        const code = String(err?.code||'').toLowerCase();
        let msg = isEs()
          ? 'No pude enviar el SMS. Revisa el número e inténtalo de nuevo.'
          : I18N.en.couldntSms;
        if (code.includes('too-many-requests')) msg = isEs()? 'Demasiados intentos. Intenta más tarde.' : 'Too many attempts. Try again later.';
        if (code.includes('captcha')) msg = isEs()? 'Hubo un problema con la verificación. Recarga la página.' : 'There was a verification issue. Please reload the page.';
        if (code.includes('network')) msg = isEs()? 'Error de red. Verifica tu conexión.' : 'Network error. Check your connection.';
        alert(msg);
      }finally{
        sendCode.disabled = false;
      }
    });

    /* ===== Reenviar ===== */
    resendBtn.addEventListener('click', ()=> showStep('form'));

    /* ===== Validar OTP ===== */
    verifyBtn.addEventListener('click', async ()=>{
      const code = (otp.value||'').trim();
      if (code.length !== 6){
        otpHint.textContent = isEs()? 'El código debe tener 6 dígitos.' : 'The code must be 6 digits.';
        return;
      }
      verifyBtn.disabled = true;
      try{
        const conf = window._sira_confirm; 
        if(!conf) throw new Error('No SMS pending');
        await conf.confirm(code);

        // Registro/Login en microservicio
        const body = {
          display_name: (friendlyName.value||'').trim(),
          phone: currentE164(),   // E.164
          accept: true,
          email: (email.value||'').trim() || undefined,
          country: (countryFree.value||'').trim() || undefined,
          birthdate: (birthdate.value||'').trim() || undefined
        };

        // >>> Referidos (añade referred_by si existe y NO es auto-referido)
        try {
          const refApi = window.SiraReferral;
          const ref = refApi && refApi.get && refApi.get();
          const isSelf = refApi && refApi.isSelf && refApi.isSelf();
          if (ref && !isSelf) {
            body.referred_by = ref;
          }
        } catch(e){ /* noop */ }

        const r = await fetch('https://siraia-auth-credits.onrender.com/signup',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });

        const data = await r.json().catch(()=> ({}));

        // Manejo correcto de errores de backend
        if (!r.ok || !data?.jwt) {
          const err = data?.error || 'SIGNUP_FAILED';
          const ES = {
            TERMS_NOT_ACCEPTED: 'Debes aceptar Términos y Privacidad.',
            MISSING_OR_INVALID_DISPLAY_NAME: 'Nombre inválido. Usa 2–32 caracteres.',
            MISSING_FIELDS: 'Faltan datos para el registro.',
            MISSING_PHONE: 'Falta tu número de celular.',
            PHONE_INVALID: 'Número inválido. Revisa el prefijo y los dígitos.',
            SIGNUP_FAILED: 'No se pudo crear la cuenta. Intenta de nuevo.'
          };
          const EN = {
            TERMS_NOT_ACCEPTED: 'You must accept Terms and Privacy.',
            MISSING_OR_INVALID_DISPLAY_NAME: 'Invalid name. Use 2–32 characters.',
            MISSING_FIELDS: 'Missing registration data.',
            MISSING_PHONE: 'Missing phone number.',
            PHONE_INVALID: 'Invalid phone. Check prefix and digits.',
            SIGNUP_FAILED: 'Could not create the account. Please try again.'
          };
          otpHint.textContent = isEs() ? (ES[err] || ES.SIGNUP_FAILED) : (EN[err] || EN.SIGNUP_FAILED);
          return; // <- no pasamos a success
        }

        // >>> Guardar sesión y nombre local para saludo inmediato
        localStorage.setItem('sira_jwt', data.jwt);
        const nameFromApi = (data?.user?.display_name || friendlyName.value || '').trim();
        localStorage.setItem('sira_display_name', nameFromApi);
        // Perfil extendido (útil para el chat)
        localStorage.setItem('sira_profile', JSON.stringify({
          display_name: nameFromApi,
          phone_e164: data?.user?.phone_e164 || currentE164()
        }));

        // Mostrar créditos reales si llegaron; si no, fallback
        const rem = data?.user?.credits_remaining ?? 10;
        const tot = data?.user?.credits_total ?? 10;
        const lead = isEs()? 'Créditos: ' : 'Credits: ';
        pillText.textContent = lead + `${rem}/${tot}`;

        // >>> Copys de éxito según is_new
        const isNew = !!data?.is_new;
        if (isNew) {
          // Alta nueva
          i_successTitle.innerHTML = isEs()
            ? '<b>¡Listo!</b> Tu cuenta fue creada.'
            : '<b>All set!</b> Your account was created.';
          i_successSub.innerHTML = isEs()
            ? 'Te regalé <b>10 créditos</b> para comenzar: puedes preguntar por <i>texto</i>, <i>audio</i> o <i>imagen + texto</i>.'
            : 'I gave you <b>10 credits</b> to start: you can ask via <i>text</i>, <i>audio</i> or <i>image + text</i>.';
        } else {
          // Re-login (NO decir “tu cuenta fue creada”)
          i_successTitle.innerHTML = isEs()
            ? `<b>¡Bienvenid@ de vuelta, ${nameFromApi}!</b>`
            : `<b>Welcome back, ${nameFromApi}!</b>`;
          i_successSub.innerHTML = isEs()
            ? `Tus créditos siguen en <b>${rem}/${tot}</b>. Puedes ir directo al chat.`
            : `Your credits remain at <b>${rem}/${tot}</b>. You can go straight to chat.`;
        }

        showStep('success');
      }catch(err){
        console.error(err);
        otpHint.textContent = isEs()? 'Código inválido. Intenta de nuevo.' : 'Invalid code. Please try again.';
      }finally{
        verifyBtn.disabled = false;
      }
    });

  </script>

  <!-- Referral helper (captura ?ref y anti-auto; usado por /signup y /checkout) -->
  <script src="/auth-credits/referral.js"></script>
</body>
</html>

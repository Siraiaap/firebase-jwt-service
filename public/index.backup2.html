<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>SiraIA ‚Äì Tu compa√±era digital confiable</title>
  <meta name="theme-color" content="#6F8576" />
  <style>
    :root{
      --bg-app: #EDEAE0;        /* fondo principal */
      --bg-chat: #F6F4EF;       /* panel chat */
      --ink-main:#3A3B3C;       /* texto principal */
      --ink-muted:#596264;      /* texto secundario */
      --brand:#6F8576;          /* acento */
      --brand-strong:#556D60;   /* hover/active */
      --bubble-bot:#FFFFFF;     /* burbuja sira */
      --bubble-user:#DCE6E0;    /* burbuja usuario */
      --border-soft:#E5E1D8;
      --play:#6F8576;           /* icono play */
      --warn:#B24B4B;           /* errores sutiles */
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius:18px;
      --radius-lg:22px;
      --radius-sm:12px;
    }

    /* Reset suave */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      color:var(--ink-main);
      background:var(--bg-app);
      display:flex;align-items:center;justify-content:center;
      min-height:100svh;
    }

    .siraia-app{
      width:100%;
      max-width:480px;
      height:100%;
      max-height:100svh;
      background:var(--bg-chat);
      border-radius:16px;
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;
      overflow:hidden;
      position:relative;
    }

    header{
      display:flex;align-items:center;gap:10px;justify-content:space-between;
      padding:12px 14px;
      background:var(--bubble-bot);
      border-bottom:1px solid var(--border-soft);
    }
    header .title{
      display:flex;align-items:center;gap:10px;
      font-weight:800; letter-spacing:.3px;
      color:var(--ink-main);
      font-size:20px;
    }
    .buy-credits-header{
      margin-left:auto;
      background: var(--brand);
      color:#fff; border:none;
      padding:8px 12px; border-radius:999px;
      font-weight:700; font-size:13px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
      cursor:pointer;
    }
    .credits{
      color:var(--ink-muted);
      font-size:12px;font-weight:700;
      background:#EEF2EE; padding:6px 10px;
      border-radius:999px; border:1px solid #E0E8E1;
    }

    #chat-history{
      flex:1 1 auto; overflow-y:auto;
      padding:18px;
      display:flex;flex-direction:column;gap:10px;
      scroll-behavior:smooth;
    }

    .bubble{
      max-width:85%;
      padding:10px 14px;
      border-radius: var(--radius);
      line-height:1.5; font-size:16px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      word-wrap:break-word;
    }
    .siraia-bubble{
      align-self:flex-start;
      background:var(--bubble-bot);
      border-top-left-radius:8px;
    }
    .user-bubble{
      align-self:flex-end;
      background:var(--bubble-user);
      border-top-right-radius:8px;
    }
    .thinking-dots{
      display:flex;gap:6px;align-items:center;
      height:18px;
    }
    .thinking-dots span{
      width:8px;height:8px;border-radius:50%;
      background:#C8D3CC; display:inline-block;
      animation:bounce 1.3s infinite ease-in-out both;
    }
    .thinking-dots span:nth-child(1){animation-delay:-.24s}
    .thinking-dots span:nth-child(2){animation-delay:-.12s}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

    .audio-controls{
      display:flex;align-items:center;gap:10px;cursor:pointer;
      user-select:none;
      margin-top:4px;
    }
    .audio-controls .play-icon{font-size:22px;color:var(--play)}

    footer{
      background:var(--bubble-bot);
      border-top:1px solid var(--border-soft);
      padding-bottom: max(8px, env(safe-area-inset-bottom));
    }
    .action-buttons{
      display:flex; justify-content:space-around; gap:4px;
      padding:8px 10px; border-top:1px solid var(--border-soft);
      background:#fff;
    }
    .action-buttons button{
      background:none;border:none;color:var(--brand);
      font-weight:800; padding:8px 10px;
      border-radius:10px; cursor:pointer;
    }
    .action-buttons button.active{background:#EEF2EE}

    .input-area{ padding:10px; }
    .input-container{ display:none; gap:10px; align-items:flex-end; justify-content:center; }
    .input-container.active{ display:flex; }

    /* Barra de entrada tipo WhatsApp/ChatGPT */
    .composer{
      display:flex;align-items:flex-end; gap:8px; width:100%;
      background:#fff; border:1px solid var(--border-soft);
      border-radius:16px; padding:8px 8px 8px 12px;
    }
    .composer textarea{
      flex:1 1 auto;
      border:none; outline:none; resize:none;
      min-height:40px; max-height: 6.5em; /* ~6 l√≠neas */
      font-size:15px; line-height:1.25;
      color:var(--ink-main); background:transparent;
    }
    .composer .send{
      flex:0 0 auto;
      width:44px; height:44px; border:none; border-radius:50%;
      background:var(--brand); color:#fff; font-size:18px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; box-shadow: 0 4px 12px rgba(0,0,0,.12);
      transition:transform .06s ease, background .15s ease;
    }
    .composer .send:active{ transform:scale(.98); background:var(--brand-strong); }

    /* Bot√≥n grabar ‚Äì estilo consistente */
    #record-button{
      width:64px;height:64px;border:none;border-radius:50%;
      background:var(--brand); color:#fff; font-size:28px;
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 6px 16px rgba(0,0,0,.18);
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
    }
    #record-button:hover{ background:var(--brand-strong); }
    #record-button.recording{
      background: linear-gradient(145deg, #6F8576 0%, #7D9788 100%);
      animation: pulse 1.2s infinite ease-in-out;
      box-shadow: 0 0 0 0 rgba(111,133,118,.4);
    }
    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(111,133,118,.45); transform:scale(1.00); }
      70%{ box-shadow:0 0 0 16px rgba(111,133,118,0); transform:scale(1.06); }
      100%{ box-shadow:0 0 0 0 rgba(111,133,118,0); transform:scale(1.00); }
    }

    /* Vista previa de imagen seleccionada */
    .preview{
      display:flex;align-items:center;gap:10px; margin:6px 0 -2px;
      color:var(--ink-muted); font-size:13px;
    }
    .preview img{
      max-width:84px; max-height:84px;
      border-radius:10px; border:1px solid var(--border-soft);
      object-fit:cover;
    }

    /* Bot√≥n compartir */
    .share-row{
      margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;
    }
    .btn-share{
      border:none; background:#EEF2EE; color:var(--brand);
      font-weight:700; font-size:13px; padding:6px 10px;
      border-radius:999px; cursor:pointer;
    }

    /* Peque√±os helpers */
    .muted{ color:var(--ink-muted); }
    .error{ color:var(--warn); font-weight:700; }

    /* Ocupa todo alto en m√≥viles con safe-area */
    .siraia-app{ padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body>
  <div class="siraia-app">
    <header>
      <div class="title">SiraIA</div>
      <button class="buy-credits-header" id="buyButton">Comprar consultas</button>
      <div class="credits" id="creditPill" data-current="8" data-total="10">Cr√©ditos: 8/10</div>
    </header>

    <main id="chat-history" aria-live="polite"></main>

    <footer>
      <div class="input-area">
        <!-- Texto ‚Üí Texto -->
        <div id="input-texto" class="input-container">
          <div class="composer">
            <textarea id="txt-prompt" rows="1" placeholder="Escribe tu pregunta‚Ä¶"></textarea>
            <button id="txt-send-button" class="send" title="Enviar">‚û§</button>
          </div>
        </div>

        <!-- Imagen + Texto ‚Üí Texto -->
        <div id="input-imagen" class="input-container">
          <div style="width:100%">
            <label class="muted" for="imgtxt-file-input">Adjunta una imagen (JPEG/PNG/WebP)</label>
            <input id="imgtxt-file-input" type="file" accept="image/jpeg, image/png, image/webp" style="width:100%" />
            <div id="imgPreview" class="preview" style="display:none">
              <img id="imgThumb" alt="Vista previa" />
              <span id="imgName" class="muted"></span>
            </div>
            <div class="composer" style="margin-top:8px">
              <textarea id="imgtxt-prompt" rows="1" placeholder="Escribe tu consulta sobre la imagen‚Ä¶"></textarea>
              <button id="imgtxt-send-button" class="send" title="Enviar">‚û§</button>
            </div>
          </div>
        </div>

        <!-- Audio ‚Üí Audio (activa por defecto) -->
        <div id="input-audio" class="input-container active" style="flex-direction:column;gap:8px">
          <div class="muted" style="font-size:13px">Pulsa para grabar tu pregunta</div>
          <button id="record-button" aria-label="Grabar">üé§</button>
        </div>
      </div>

      <div class="action-buttons">
        <button data-input="input-texto" id="tab-texto">üìù Escribir</button>
        <button data-input="input-imagen" id="tab-imagen">üñº Imagen</button>
        <button data-input="input-audio" id="tab-audio" class="active">üé§ Hablar</button>
      </div>
    </footer>

    <!-- Audio oculto para reproducir respuestas -->
    <audio id="siraia-audio-player"></audio>
  </div>

  <script>
    /* ====== Seguridad de logs ====== */
    const DEBUG = false;
    const log = (...args) => { if (DEBUG) console.log(...args); };

    function redactUrl(raw){
      try{
        const u = new URL(String(raw||''));
        if (u.searchParams.has('token')){
          const t = u.searchParams.get('token')||'';
          const masked = t.length>8? t.slice(0,4)+'‚Ä¶'+t.slice(-4) : '***';
          u.searchParams.set('token', masked);
        }
        return u.toString();
      }catch{ return '(invalid-url)' }
    }

    /* ====== Elementos ====== */
    const chatHistory   = document.getElementById('chat-history');
    const recordButton  = document.getElementById('record-button');
    const audioPlayer   = document.getElementById('siraia-audio-player');

    const tabButtons    = document.querySelectorAll('.action-buttons button');
    const inputBlocks   = document.querySelectorAll('.input-container');

    const txtArea       = document.getElementById('txt-prompt');
    const txtSend       = document.getElementById('txt-send-button');

    const imgInput      = document.getElementById('imgtxt-file-input');
    const imgPreview    = document.getElementById('imgPreview');
    const imgThumb      = document.getElementById('imgThumb');
    const imgName       = document.getElementById('imgName');
    const imgTxtArea    = document.getElementById('imgtxt-prompt');
    const imgTxtSend    = document.getElementById('imgtxt-send-button');

    const buyButton     = document.getElementById('buyButton');

    /* ====== Endpoints (producci√≥n) ====== */
    const WH_AUDIO  = 'https://siraiaap.app.n8n.cloud/webhook/entrada-audio';
    const WH_TEXT   = 'https://siraiaap.app.n8n.cloud/webhook/siraia-pregunta';
    const WH_IMAGE  = 'https://siraiaap.app.n8n.cloud/webhook/siraia-imagen';

    /* ====== Utilidades ====== */
    function scrollToBottom(){ chatHistory.scrollTop = chatHistory.scrollHeight; }

    function autogrow(el){
      el.style.height = 'auto';
      const max = parseFloat(getComputedStyle(el).lineHeight) * 6; // ~6 l√≠neas
      el.style.height = Math.min(el.scrollHeight, max) + 'px';
    }

    function sanitizeUrl(raw){
      return String(raw||'')
        .replace(/(\r\n|\n|\r|\t)/g,'')
        .replace(/[\u200B-\u200D\uFEFF]/g,'')
        .trim();
    }

    function addUserBubble(text, type='text'){
      const bubble = document.createElement('div');
      bubble.className = 'bubble user-bubble';

      const content = document.createElement('div');
      if (type==='transcription'){
        content.textContent = 'Tu pregunta de voz‚Ä¶';
      }else{
        content.textContent = String(text||'');
      }
      bubble.appendChild(content);
      chatHistory.appendChild(bubble);
      scrollToBottom();
      return content;
    }

    function addSiraiaThinkingBubble(){
      const bubble = document.createElement('div');
      bubble.className = 'bubble siraia-bubble';
      bubble.innerHTML = `<div class="thinking-dots"><span></span><span></span><span></span></div>`;
      chatHistory.appendChild(bubble);
      scrollToBottom();
      return bubble;
    }

    function renderBotText(bubble, text){
      bubble.innerHTML = '';
      const p = document.createElement('p');
      p.textContent = String(text||'');
      bubble.appendChild(p);

      // bot√≥n compartir
      const row = document.createElement('div');
      row.className = 'share-row';
      const btn = document.createElement('button');
      btn.className = 'btn-share';
      btn.textContent = 'Compartir';
      btn.onclick = () => shareText(String(text||''));
      row.appendChild(btn);
      bubble.appendChild(row);
    }

    async function shareText(text){
      const msg = String(text||'');
      if (navigator.share){
        try{ await navigator.share({ text: msg }); }catch{}
      }else{
        const url = 'https://wa.me/?text=' + encodeURIComponent(msg);
        window.open(url, '_blank');
      }
    }

    function updateSiraiaBubble(bubble, responseData){
      // si el endpoint devolviera text adem√°s de audio
      if (responseData && typeof responseData.text === 'string' && responseData.text.trim()){
        renderBotText(bubble, responseData.text);
      }else{
        bubble.innerHTML='';
      }

      const payload = Array.isArray(responseData)? responseData[0] : responseData || {};
      const rawAudioUrl = payload.audioUrl ?? payload.respuestaFinal ?? '';
      const cleanAudioUrl = sanitizeUrl(rawAudioUrl);

      if (cleanAudioUrl){
        try{ new URL(cleanAudioUrl); }catch{
          const warn = document.createElement('div');
          warn.className='error'; warn.textContent='La URL de audio lleg√≥ corrupta.';
          bubble.appendChild(warn); return;
        }

        const play = document.createElement('div');
        play.className='audio-controls';
        play.innerHTML = `<span class="play-icon">‚ñ∂Ô∏è</span> Escuchar respuesta`;

        audioPlayer.preload='auto';
        audioPlayer.src = cleanAudioUrl;

        play.onclick = async ()=>{
          try{
            await audioPlayer.play();
            play.innerHTML = `<span class="play-icon">üîä</span> Reproduciendo‚Ä¶`;
            play.style.pointerEvents='none';
          }catch{
            play.textContent='‚ùå Error al reproducir';
            play.style.color='#B24B4B';
            play.style.pointerEvents='auto';
          }
        };
        audioPlayer.onended = ()=>{
          play.innerHTML = `<span class="play-icon">‚ñ∂Ô∏è</span> Escuchar de nuevo`;
          play.style.pointerEvents='auto';
        };
        audioPlayer.onerror = ()=>{
          play.textContent='‚ùå Error al cargar audio';
          play.style.color='#B24B4B';
          play.style.pointerEvents='auto';
        };

        bubble.appendChild(play);
      }

      scrollToBottom();
    }

    /* ====== Tabs ====== */
    tabButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.input;
        tabButtons.forEach(b=>b.classList.toggle('active', b===btn));
        inputBlocks.forEach(c=>c.classList.toggle('active', c.id===id));
      });
    });

    /* ====== Textarea autogrow ====== */
    [txtArea, imgTxtArea].forEach(el=>{
      if(!el) return;
      el.addEventListener('input', ()=>autogrow(el));
      // initialize
      autogrow(el);
    });

    /* ====== Audio ‚Üí Audio ====== */
    let isRecording = false, mediaRecorder, audioChunks=[], durationTimeout;

    async function startRecording(){
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('Tu navegador no permite grabar audio.'); return;
      }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        const options = { mimeType: 'audio/webm;codecs=opus' };
        mediaRecorder = new MediaRecorder(stream, options);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = ()=>{
          const blob = new Blob(audioChunks, { type: options.mimeType });
          const rd = new FileReader();
          rd.onloadend = ()=> sendAudio(rd.result);
          rd.readAsDataURL(blob);
        };
        mediaRecorder.start();
        isRecording = true;
        recordButton.classList.add('recording');
        durationTimeout = setTimeout(()=>{ if(isRecording) stopRecording(); }, 60000);
      }catch{
        alert('No se pudo acceder al micr√≥fono. Revisa permisos.');
      }
    }
    function stopRecording(){
      if (mediaRecorder && mediaRecorder.state==='recording'){ mediaRecorder.stop(); }
      isRecording=false;
      recordButton.classList.remove('recording');
    }

    recordButton.addEventListener('click', ()=> isRecording ? stopRecording() : startRecording());

    async function sendAudio(base64Audio){
      const userBubbleContent = addUserBubble('', 'transcription');
      const thinking = addSiraiaThinkingBubble();
      try{
        const res = await fetch(WH_AUDIO,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ audio_base64: base64Audio })
        });
        let data;
        try{ data = await res.json(); }
        catch{
          const t = await res.text();
          try{ data = JSON.parse(t); }catch{
            renderBotText(thinking, 'Respuesta no v√°lida del servidor.');
            return;
          }
        }
        const payload = Array.isArray(data)? data[0]: data;
        if (payload && payload.transcription){
          userBubbleContent.textContent = `"${payload.transcription}"`;
        }
        updateSiraiaBubble(thinking, payload);
      }catch{
        thinking.textContent='Ocurri√≥ un error. Intenta de nuevo.';
      }
    }

    /* ====== Texto ‚Üí Texto ====== */
    txtSend.addEventListener('click', ()=>{
      const q = (txtArea.value||'').trim();
      if(!q){ alert('Escribe una pregunta.'); return; }
      sendText(q); txtArea.value=''; autogrow(txtArea);
    });

    async function sendText(question){
      addUserBubble(question, 'text');
      const thinking = addSiraiaThinkingBubble();
      try{
        // Enviamos redundante para m√°xima compatibilidad backend
        const res = await fetch(WH_TEXT,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text: question, pregunta: question, Texto: question })
        });
        const raw = await res.text();
        let data;
        try{ data = JSON.parse(raw); }catch{ data = { text: raw }; }

        // normalizamos: algunos flujos devuelven array/obj y la clave puede ser Texto o text
        const payload = Array.isArray(data) ? data[0] : data;
        const answer = payload?.Texto ?? payload?.text ?? String(raw||'');
        renderBotText(thinking, answer);
      }catch{
        renderBotText(thinking, 'Lo siento, ocurri√≥ un error al procesar tu pregunta.');
      }
    }

    /* ====== Imagen + Texto ‚Üí Texto ====== */
    let selectedImageBase64 = null, selectedObjectURL=null;

    imgInput.addEventListener('change', async (evt)=>{
      const f = evt.target.files && evt.target.files[0];
      imgPreview.style.display = 'none';
      selectedImageBase64 = null;

      if (!f){ return; }
      if (!['image/jpeg','image/png','image/webp'].includes(f.type)){
        alert('Formato no compatible. Usa JPEG, PNG o WebP.'); imgInput.value=''; return;
      }
      if (f.size > 10*1024*1024){
        alert('La imagen es muy grande (m√°x 10 MB).'); imgInput.value=''; return;
      }
      // Previsualizaci√≥n
      if (selectedObjectURL){ URL.revokeObjectURL(selectedObjectURL); }
      selectedObjectURL = URL.createObjectURL(f);
      imgThumb.src = selectedObjectURL;
      imgName.textContent = f.name;
      imgPreview.style.display = 'flex';

      // a Base64
      selectedImageBase64 = await new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = (e)=> reject(e);
        r.readAsDataURL(f);
      });
    });

    imgTxtSend.addEventListener('click', ()=>{
      const q = (imgTxtArea.value||'').trim();
      if (!selectedImageBase64){
        alert('Primero selecciona una imagen.'); return;
      }
      // Si no hay texto, permitimos continuar con prompt gen√©rico
      sendImageAndText(selectedImageBase64, q);
      // Pintamos ‚Äúmensaje del usuario‚Äù con miniatura y texto
      const user = addUserBubble(q || '(Imagen enviada)', 'text');
      if (selectedObjectURL){
        const wrap = document.createElement('div');
        wrap.className='preview'; wrap.style.marginTop='6px';
        const img = document.createElement('img');
        img.src = selectedObjectURL; img.alt='Imagen enviada';
        wrap.appendChild(img);
        user.parentElement.appendChild(wrap);
      }
      // limpiar
      imgTxtArea.value=''; autogrow(imgTxtArea);
      imgInput.value=''; imgPreview.style.display='none';
      selectedImageBase64 = null;
      if (selectedObjectURL){ URL.revokeObjectURL(selectedObjectURL); selectedObjectURL=null; }
    });

    async function fetchJsonWithFallback(url, payload){
      const res = await fetch(url,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload||{})
      });
      try{ const d = await res.json(); return { ok: res.ok, data:d, raw:null }; }
      catch{
        const raw = await res.text();
        try{ return { ok: res.ok, data: JSON.parse(raw), raw }; }
        catch{ return { ok: res.ok, data:null, raw }; }
      }
    }

    async function sendImageAndText(imageBase64, promptText){
      const thinking = addSiraiaThinkingBubble();
      try{
        // Enviamos varias claves para compatibilidad del backend actual
        const { ok, data, raw } = await fetchJsonWithFallback(WH_IMAGE,{
          image_base64: imageBase64,
          text: promptText,         // preferida
          Texto: promptText,        // fallback 1
          texto: promptText,        // fallback 2
          prompt: promptText        // fallback 3
        });

        if (!ok){ renderBotText(thinking, 'Ocurri√≥ un error con el servidor.'); return; }

        const payload = Array.isArray(data)? data[0]: data;
        const answer = payload?.Texto ?? payload?.text ?? (typeof payload==='string'? payload : raw);
        if (!answer || typeof answer!=='string'){
          renderBotText(thinking, 'Lo siento, ocurri√≥ un error al procesar la imagen.');
          return;
        }
        renderBotText(thinking, answer);
      }catch{
        renderBotText(thinking, 'Lo siento, ocurri√≥ un error al procesar la imagen.');
      }
    }

    /* ====== Comprar cr√©ditos (placeholder) ====== */
    buyButton.addEventListener('click', ()=>{
      alert('Pr√≥ximamente: compra de consultas. üôÇ');
    });
  </script>
</body>
</html>
